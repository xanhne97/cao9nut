<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B√†i C√†o Online</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
  font-family:Arial;
  text-align:center;
  background:linear-gradient(135deg,#0b5,#063);
  color:#fff;
}
.deal-card{
  position:fixed;
  width:80px;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  transition:all 0.5s ease;
  z-index:999;
}
.card-wrap{
  display:flex;
  justify-content:center;
  gap:15px;
  margin:20px;
}

.card{
  width:80px;
  height:120px;
  perspective:600px;
}

.inner{
  width:100%;
  height:100%;
  position:relative;
  transform-style:preserve-3d;
  transition:0.6s;
}

.flip .inner{
  transform:rotateY(180deg);
}

.front,.back{
  position:absolute;
  width:100%;
  height:100%;
  border-radius:10px;
  backface-visibility:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:bold;
}

.back{
  background:#fff;
  color:#000;
  border:2px solid #333;
  transform:rotateY(180deg);
}

.front{
  background:url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTfIo1FzIdgzvlGl-hVJ4xNjKWTjkxrcBs4KQ&s');
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  width:100%;
  height:100%;
}

button{
  padding:10px 20px;
  font-size:16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<h2>üÉè B√†i C√†o Online</h2>

<input id="name" placeholder="T√™n b·∫°n">
<button onclick="join()">V√†o b√†n</button>

<div id="players"></div>

<button id="dealBtn" onclick="deal()" style="display:none">Chia b√†i (Host)</button>
<button id="resetBtn" onclick="resetGame()" style="display:none">
  V√°n m·ªõi
</button>

<h3>B√†i c·ªßa b·∫°n</h3>
<div class="card-wrap" id="cards"></div>

<button onclick="reveal()">L·∫≠t b√†i</button>

<div id="result"></div>

<h3>üìú Nh·∫≠t k√Ω b√†n</h3>
<div id="logBox" style="height:120px;overflow:auto;background:#0003;padding:10px"></div>

<h3>üèÖ B·∫£ng ƒëi·ªÉm</h3>
<div id="scoreBox"></div>

<script>
const socket=io();
let myCards=[];

const suits=["‚ô†","‚ô•","‚ô¶","‚ô£"];
const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

function join(){
  socket.emit("join",document.getElementById("name").value);
}
async function animateDeal(){
  let container=document.getElementById("cards");
  let targets=[...container.children];

  if(targets.length===0) return;

  for(let i=0;i<targets.length;i++){
    await dealOne(targets[i],i);
    await delay(220);
  }
}

function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

function dealOne(target,i){
  return new Promise(resolve=>{
    let rect=target.getBoundingClientRect();

    let card=document.createElement("img");
    card.src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/54/Card_back_05.svg/200px-Card_back_05.svg.png";
    card.className="deal-card";

    document.body.appendChild(card);

    // offset nh·∫π cho gi·ªëng dealer chia
    let angle=(i-1)*8;

    setTimeout(()=>{
      card.style.left=rect.left+"px";
      card.style.top=rect.top+"px";
      card.style.transform=`translate(0,0) rotate(${angle}deg)`;
    },40);

    setTimeout(()=>{
      card.remove();
      resolve();
    },500);
  });
}
function deal(){ socket.emit("deal"); }

function reveal(){
  document.querySelectorAll(".card").forEach(c=>c.classList.add("flip"));

  if(isSap(myCards)){
    let v=sapValue(myCards);
    document.getElementById("result").innerHTML=
      `<h2>üí• S√ÅP ${v==1?"A":ranks[v-1]} TH·∫ÆNG TR·∫ÆNG üí•</h2>`;

    document.querySelectorAll(".card").forEach(c=>{
      c.style.boxShadow="0 0 20px gold";
    });

  }else if(isThreeFace(myCards)){
    document.getElementById("result").innerHTML=
      `<h2>üî• 3 T√ÇY TH·∫ÆNG TR·∫ÆNG üî•</h2>`;

    document.querySelectorAll(".card").forEach(c=>{
      c.style.boxShadow="0 0 20px orange";
    });

  }else{
    let score=calcScore(myCards);
    document.getElementById("result").innerHTML=
      `<h2>ƒêi·ªÉm c·ªßa b·∫°n: ${score==0?"B√π":score}</h2>`;
  }

  socket.emit("reveal");
}

socket.on("players",(list)=>{
  document.getElementById("players").innerHTML=
    "Ng∆∞·ªùi ch∆°i: "+list.map(p=>p.name).join(", ");
});

socket.on("yourCards",async (cards)=>{
  myCards=cards;

  renderCards(false); // t·∫°o khung tr∆∞·ªõc
  await animateDeal();
});

function renderCards(show){
  let html="";

  myCards.forEach((c)=>{
    let rankIndex=(c-1)%13;
    let suitIndex=Math.floor((c-1)/13);

    let rankMap=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    let suitMap=["S","H","D","C"];

    let rank=rankMap[rankIndex];
    let suit=suitMap[suitIndex];

    let img=`https://deckofcardsapi.com/static/img/${rank}${suit}.png`;

    html+=`
      <div class="card ${show?"flip":""}">
        <div class="inner">
          <div class="front"></div>
          <div class="back">
            <img src="${img}" width="80">
          </div>
        </div>
      </div>
    `;
  });

  document.getElementById("cards").innerHTML=html;
}
socket.on("players",(data)=>{
  document.getElementById("players").innerHTML=
    "Host: "+(data.host||"")+
    "<br>Ng∆∞·ªùi ch∆°i: "+data.list.map(p=>p.name).join(", ");
});

socket.on("isHost",(v)=>{
  document.getElementById("dealBtn").style.display=v?"inline-block":"none";
  document.getElementById("resetBtn").style.display=v?"inline-block":"none";
});

function resetGame(){
  socket.emit("reset");
}
socket.on("showAll",(players)=>{
  let html="<h3>K·∫øt qu·∫£</h3>";
  Object.values(players).forEach(p=>{
    html+=`<p>${p.name}: ${p.cards.join("-")} ‚Üí ${p.score==0?"B√π":p.score}</p>`;
  });
  document.getElementById("result").innerHTML=html;
});
socket.on("log",(msg)=>{
  let box=document.getElementById("logBox");
  box.innerHTML+="<div>"+msg+"</div>";
  box.scrollTop=box.scrollHeight;
});

socket.on("scoreboard",(list)=>{
  let html="<table border='1' style='margin:auto;background:#fff;color:#000'>";
  html+="<tr><th>T√™n</th><th>ƒêi·ªÉm th·∫Øng</th></tr>";
  list.forEach(p=>{
    html+=`<tr><td>${p.name}</td><td>${p.total}</td></tr>`;
  });
  html+="</table>";
  document.getElementById("scoreBox").innerHTML=html;
});

socket.on("winner",(w)=>{
  document.getElementById("result").innerHTML+=
    `<h2>üèÜ ${w.winner} th·∫Øng (${w.max==0?"B√π":w.max})</h2>`;
});
socket.on("resetGame",()=>{
  document.getElementById("cards").innerHTML="";
  document.getElementById("result").innerHTML="";
});
function calcScore(cards){
  let sum=0;

  cards.forEach(c=>{
    let rank=(c-1)%13 + 1; // 1=A, 11=J,12=Q,13=K

    if(rank==1 || rank>=11){
      sum+=10; // A J Q K = 10
    }else{
      sum+=rank;
    }
  });

  return sum%10;
}
function isThreeFace(cards){
  return cards.every(c=>{
    let rank=(c-1)%13 + 1;
    return rank>=11; // J Q K
  });
}
function isSap(cards){
  let ranks=cards.map(c=>(c-1)%13);
  return ranks[0]==ranks[1] && ranks[1]==ranks[2];
}
function sapValue(cards){
  return (cards[0]-1)%13 + 1; // 1=A ... 13=K
}
</script>

</body>
</html>